<!DOCTYPE html>
<html lang="id">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>PILKETOS SKANEGU 2025 - Login Pemilih (Magang)</title>
    <link rel="stylesheet" href="style.css" />
  </head>
  <body>
    <div class="container">
      <header>
        <h1>üó≥Ô∏è PILKETOS SKANEGU 2025 üó≥Ô∏è</h1>
        <p>
          Khusus untuk siswa yang sedang magang (PKL).
          Silakan masukkan Nama Lengkap dan Token unik Anda.
        </p>
      </header>

      <main>
        <form id="intern-login-form" class="login-form-container">
          <div class="form-group">
            <label for="voter-name">Nama Lengkap:</label>
            <input
              type="text"
              id="voter-name"
              required
              placeholder="Masukkan nama lengkap sesuai data..."
            />
          </div>

          <div class="form-group">
            <label for="voter-token">Token:</label>
            <input
              type="text"
              id="voter-token"
              required
              placeholder="Masukkan token unik Anda..."
            />
          </div>

          <button
            type="submit"
            class="vote-btn"
            style="width: 100%; margin-top: 20px"
          >
            Verifikasi & Lanjut Voting
          </button>

          <!-- <p style="text-align: center; margin-top: 20px;">
             Bukan siswa magang? <a href="index.html">Kembali ke login reguler</a>.
          </p> -->
        </form>
      </main>
    </div>

    <script>
      // ==========================================================
      // KEDUA API ENDPOINT (ABSENSI DAN TOKEN)
      // ==========================================================
      
      // API Absensi Reguler (Sama seperti di index.html)
      const ATTENDANCE_API_URL = "https://sheetdb.io/api/v1/xj4dsevzqdgpr"; 
      
      // API Khusus Validasi Token Magang
      const TOKEN_API_URL = "https://sheetdb.io/api/v1/dz4olweo9hsa0"; 

      // ===============================
      // Ambil elemen HTML
      // ===============================
      const loginForm = document.getElementById("intern-login-form");
      const voterNameInput = document.getElementById("voter-name");
      const tokenInput = document.getElementById("voter-token");

      // Auto-uppercase untuk input nama
      voterNameInput.addEventListener("input", function () {
        this.value = this.value.toUpperCase();
      });

      // ==========================================================
      // Event Listener saat FORM DI-SUBMIT (VERSI LENGKAP)
      // ==========================================================
      loginForm.addEventListener("submit", async function (event) {
        event.preventDefault();

        const submitButton = this.querySelector('button[type="submit"]');
        const name = voterNameInput.value.trim();
        const token = tokenInput.value.trim();

        if (!name || !token) {
          alert("Nama dan Token wajib diisi!");
          return;
        }

        submitButton.disabled = true;
        submitButton.textContent = "Mengunduh data...";

        try {
          // 1. Ambil SEMUA data dari API Token
          const responseRead = await fetch(TOKEN_API_URL); 

          if (!responseRead.ok) {
            throw new Error(`Gagal terhubung ke server database token. (Error: ${responseRead.status})`);
          }

          const allVoterData = await responseRead.json(); 
          submitButton.textContent = "Mencocokkan data...";

          // 2. Cari data yang cocok di browser (JavaScript .find())
          const voterRecord = allVoterData.find(record => 
              record.name === name && record.token === token
          );

          // 3. Validasi Pencarian Lokal
          if (!voterRecord) {
            throw new Error("Data tidak ditemukan. Pastikan Nama dan Token sesuai.");
          }
          
          // 4. Validasi Status (Cek apakah token sudah dipakai)
          if (voterRecord.status && voterRecord.status.toUpperCase() !== "BELUM") {
             throw new Error("Token ini sudah digunakan untuk memilih.");
          }
           
          // === LOLOS VALIDASI (Data ada dan status 'BELUM') ===
          
          submitButton.textContent = "Memperbarui status...";

          // 5. UPDATE STATUS TOKEN (PATCH): Ubah status 'BELUM' menjadi 'SUDAH'
          const updateUrl = `${TOKEN_API_URL}/token/${encodeURIComponent(token)}`;
          const updateData = {
              status: "SUDAH", 
              timestamp: new Date().toISOString()
          };

          const responseUpdate = await fetch(updateUrl, {
              method: 'PATCH',
              headers: {
                  'Accept': 'application/json',
                  'Content-Type': 'application/json'
              },
              body: JSON.stringify(updateData)
          });
          
          if (!responseUpdate.ok) {
             throw new Error("Gagal memperbarui status data token. Pastikan izin PATCH aktif.");
          }

          // ==========================================================
          // 6. (FITUR BARU) KIRIM DATA ABSENSI KE SHEET UTAMA
          // ==========================================================
          submitButton.textContent = "Mencatat Absensi...";

          const dataToSendToAttendance = {
            name: voterRecord.name,
            major: "MAGANG", // Tandai jurusannya sebagai "MAGANG"
            className: voterRecord.token, // Gunakan token sebagai identitas kelas
            timestamp: new Date().toISOString(),
          };

          try {
              const responseAttendance = await fetch(ATTENDANCE_API_URL, {
                  method: 'POST',
                  headers: {
                      'Accept': 'application/json',
                      'Content-Type': 'application/json'
                  },
                  body: JSON.stringify(dataToSendToAttendance) 
              });

              if (!responseAttendance.ok) {
                  // Jika GAGAL kirim absensi, JANGAN hentikan vote.
                  // Cukup catat sebagai peringatan di console.
                  console.warn("Peringatan: Gagal mencatat absensi intern, tapi vote tetap dilanjutkan.");
              }
          } catch (attendanceError) {
              // Jika fetch ke absensi gagal, jangan hentikan vote
              console.warn("Error saat mencatat absensi intern:", attendanceError.message);
          }

          // ==========================================================
          // 7. (FITUR BARU) SIMPAN DATA KE LOCALSTORAGE UNTUK VOTE & REDIRECT
          // ==========================================================
          const dataForStorage = {
              name: voterRecord.name,
              major: "MAGANG", 
              className: voterRecord.token 
          };
          
          // Simpan data voter (agar lolos penjaga di vote.html)
          localStorage.setItem("pilketosVoterData", JSON.stringify(dataForStorage));
          
          // Simpan halaman asal (agar thanks.html tahu harus kembali ke mana)
          // (Ganti 'intern-vote.html' jika nama file Anda 'magang.html')
          localStorage.setItem("pilketosOriginPath", "intern-vote.html"); 

          // 8. Lanjut ke halaman vote
          window.location.href = "vote.html";

        } catch (err) {
          alert("Verifikasi Gagal:\n\n" + err.message);
          console.error(err);
          
          submitButton.disabled = false;
          submitButton.textContent = "Verifikasi & Lanjut Voting";
        }
      });
    </script>
  </body>
</html>