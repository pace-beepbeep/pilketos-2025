<!DOCTYPE html>
<html lang="id">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>PILKETOS SKANEGU 2025 - Login Pemilih</title>
    <link rel="stylesheet" href="style.css" />
  </head>
  <body>
    <div class="container">
      <header>
        <h1>üó≥Ô∏è PILKETOS SKANEGU 2025 üó≥Ô∏è</h1>
        <p>Silakan isi data Anda untuk melanjutkan ke halaman voting.</p>
      </header>

      <main>
        <form id="login-form" class="login-form-container">
          <div class="form-group">
            <label for="voter-name">Nama Lengkap:</label>
            <input
              type="text"
              id="voter-name"
              required
              placeholder="Masukkan nama lengkap Anda..."
            />
          </div>

          <div class="form-group">
            <label for="voter-major">Jurusan:</label>
            <select id="voter-major" required>
              <option value="">--- Pilih Jurusan ---</option>
              <option value="RPL">Rekayasa Perangkat Lunak</option>
              <option value="TKJ">Teknik Komputer dan Jaringan</option>
              <option value="DKV">Desain Komunikasi Visual</option>
              <option value="ANIMASI">Animasi</option>
              <option value="PERHOTELAN">Perhotelan</option>
              <option value="TATABOGA">Tata Boga</option>
            </select>
          </div>

          <div class="form-group hidden" id="class-selection-group">
            <label for="voter-class">Kelas:</label>
            <select id="voter-class" required></select>
          </div>

          <button
            type="submit"
            class="vote-btn"
            style="width: 100%; margin-top: 20px"
          >
            Lanjut ke Voting
          </button>
        </form>
      </main>
    </div>

    <script>
      // Data Struktur Kelas (VERSI TERBARU ANDA)
      const classData = {
        RPL: [
          "X RPL 1", "X RPL 2", "X RPL 3",
          "XI RPL 1", "XI RPL 2", "XI RPL 3",
          "XII RPL 1", "XII RPL 2", "XII RPL 3",
        ],
        TKJ: [
          "X TKJ 1", "X TKJ 2", "X TKJ 3",
          "XI TKJ 1", "XI TKJ 2", "XI TKJ 3",
          "XII TKJ 1", "XII TKJ 2", "XII TKJ 3",
        ],
        MM: [ // Catatan: Anda mendaftarkan DKV di option tapi key-nya MM. Saya biarkan sesuai struktur data Anda.
          "X DKV 1", "X DKV 2", "X DKV 3",
          "XI DKV 1", "XI DKV 2", "XI DKV 3",
          "XII DKV 1", "XII DKV 2", "XII DKV 3",
        ],
        ANIMASI: [
          "X ANIMASI 1", "X ANIMASI 2",
          "XI ANIMASI 1", "XI ANIMASI 2",
          "XII ANIMASI 1", "XII ANIMASI 2",
        ],
        PERHOTELAN: [
          "X PERHOTELAN 1", "X PERHOTELAN 2",
          "XI PERHOTELAN 1", "XI PERHOTELAN 2",
          "XII PERHOTELAN 1", "XII PERHOTELAN 2",
        ],
        TATABOGA: [
          "X TATABOGA 1", "X TATABOGA 2", "X TATABOGA 3",
          "XI TATABOGA 1", "XI TATABOGA 2", "XI TATABOGA 3",
          "XII TATABOGA 1", "XII TATABOGA 2", "XII TATABOGA 3",
        ],
      };

      // ===============================
      // Ambil elemen HTML
      // ===============================
      const majorSelect = document.getElementById("voter-major");
      const classSelect = document.getElementById("voter-class");
      const classGroup = document.getElementById("class-selection-group");
      const loginForm = document.getElementById("login-form");
      const voterNameInput = document.getElementById("voter-name");

      // ===============================
      // Auto-uppercase untuk input nama
      // ===============================
      voterNameInput.addEventListener("input", function () {
        this.value = this.value.toUpperCase();
      });

      // ===============================
      // 1. Event Listener saat JURUSAN BERUBAH
      // ===============================
      majorSelect.addEventListener("change", function () {
        // Jika jurusannya DKV, tapi key di data adalah MM, kita ubah di sini
        let selectedMajor = this.value;
        if (selectedMajor === "DKV") {
            selectedMajor = "MM"; // Sesuaikan dengan key di object classData
        }
        
        classSelect.innerHTML = '<option value="">--- Pilih Kelas ---</option>';

        if (selectedMajor && classData[selectedMajor]) {
          const classes = classData[selectedMajor];
          classes.forEach(function (className) {
            const option = document.createElement("option");
            option.value = className;
            option.textContent = className;
            classSelect.appendChild(option);
          });
          classGroup.classList.remove("hidden");
        } else {
          classGroup.classList.add("hidden");
        }
      });

      // ==========================================================
      // 2. Event Listener saat FORM DI-SUBMIT (VERSI SHEETDB/SHEETY)
      // ==========================================================

      // GANTI URL INI dengan API Endpoint dari SheetDB atau Sheety Anda
      const THIRD_PARTY_API_URL = "https://sheetdb.io/api/v1/xj4dsevzqdgpr"; // <-- GANTI INI

      loginForm.addEventListener("submit", async function (event) {
        event.preventDefault();
        
        const submitButton = this.querySelector('button[type="submit"]');
        const name = voterNameInput.value.trim();
        const major = majorSelect.value;
        const className = classSelect.value;

        if (!name || !major || !className) {
          alert("Nama, Jurusan, dan Kelas wajib diisi!");
          return;
        }

        // Matikan tombol agar tidak di-klik dua kali
        submitButton.disabled = true;
        submitButton.textContent = "Mencatat Kehadiran...";

        const dataToSend = {
          name: name,
          major: major,
          className: className,
          timestamp: new Date().toISOString(),
        };

        try {
          // 1. Kirim data ke API Pihak Ketiga (SheetDB/Sheety)
          // 1. Kirim data ke API Pihak Ketiga (SheetDB)
          const response = await fetch(THIRD_PARTY_API_URL, {
              method: 'POST',
              headers: {
                  'Accept': 'application/json',
                  'Content-Type': 'application/json'
              },
              
              // ============ PERBAIKAN DI SINI ============
              // Hapus pembungkus "{ data: ... }" dan kirim objek dataToSend secara langsung.
              body: JSON.stringify(dataToSend)
              // ===========================================
          });

          if (!response.ok) {
             // Jika server error (API salah, spreadsheet penuh, dll)
             const errorData = await response.json();
             throw new Error(`Gagal mengirim data: ${errorData.error || response.statusText}`);
          }

          // 2. Jika BERHASIL kirim, simpan ke localStorage untuk penjaga halaman vote
          localStorage.setItem("pilketosVoterData", JSON.stringify(dataToSend));
          
          // === TAMBAHAN BARU (MEMENUHI PERMINTAAN ANDA) ===
          // Simpan halaman asal agar thanks.html tahu harus kembali ke mana
          localStorage.setItem("pilketosOriginPath", "index.html"); 
          // =================================================

          // 3. Lanjut ke halaman vote
          window.location.href = "vote.html";

        } catch (err) {
          // Tangani jika GAGAL kirim (misal: tidak ada internet atau API salah)
          alert("Gagal mencatat data. Pastikan Anda terhubung ke internet dan coba lagi.\n\nError: " + err.message);
          console.error(err);
          
          // Hidupkan lagi tombolnya jika gagal
          submitButton.disabled = false;
          submitButton.textContent = "Lanjut ke Voting";
        }
      });
    </script>
  </body>
</html>
